const express = require("express");
const fs = require("fs");
const path = require("path");
const { v4: uuidv4 } = require("uuid");

const app = express();

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

const uploadDir = path.join(__dirname, "post_uploads");
const postsFile = path.join(uploadDir, "posts.json");

if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir);
}
if (!fs.existsSync(postsFile)) {
    fs.writeFileSync(postsFile, JSON.stringify([]));
}

function getPosts() {
    return JSON.parse(fs.readFileSync(postsFile, "utf-8"));
}
function savePosts(posts) {
    fs.writeFileSync(postsFile, JSON.stringify(posts, null, 2));
}

app.get("/", (req, res) => {
    res.send("Hello From Server!!!")
})

app.get("/UploadPost", (req, res) => {
    const posts = getPosts();

    let html = `
  <html>
    <head>
      <title>Create Post</title>
      <style>
        body { font-family: Arial; margin: 20px; }
        .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-bottom: 20px; width: 400px; }
        img { width: 100%; height: 250px; object-fit: cover; border-radius: 6px; }
        .comment-box { margin-top: 10px; }
        .comments { margin-top: 10px; padding-left: 10px; }
        .comment { border-top: 1px solid #eee; padding: 5px 0; }
      </style>
    </head>
    <body>
      <h1>Create a Post</h1>
      <form method="POST" action="/addPost">
        <input type="text" name="link" placeholder="Enter Image Link" required /><br/><br/>
        <input type="text" name="description" placeholder="Add Description" required /><br/><br/>
        <button type="submit">Add</button>
      </form>
      <hr/>
      <h2>Posts</h2>
  `;

    posts.forEach(post => {
        html += `
      <div class="card">
        <img src="${post.link}" alt="Post Image"/>
        <p>${post.description}</p>
        <form method="POST" action="/addComment/${post.id}" class="comment-box">
          <input type="text" name="comment" placeholder="Add a comment" required />
          <button type="submit">Comment</button>
        </form>
        <div class="comments">
          ${post.comments.map(c => `<div class="comment">${c}</div>`).join("")}
        </div>
      </div>
    `;
    });

    html += "</body></html>";

    res.send(html);
});

app.post("/addPost", (req, res) => {
    const { link, description } = req.body;
    let posts = getPosts();

    const newPost = {
        id: uuidv4(),
        link,
        description,
        comments: []
    };

    posts.unshift(newPost); // Add newest post at top
    savePosts(posts);

    res.redirect("/UploadPost");
});

app.post("/addComment/:id", (req, res) => {
    const { id } = req.params;
    const { comment } = req.body;

    let posts = getPosts();
    const post = posts.find(p => p.id === id);

    if (post) {
        post.comments.push(comment);
        savePosts(posts);
    }

    res.redirect("/UploadPost");
});

app.listen(7000, () => {
    console.log("âœ… Server Started On Port: 7000");
});
